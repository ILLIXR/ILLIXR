<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://illixr.github.io/ILLIXR/docs/writing_your_plugin/">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Writing your Plugin (Version 2) - ILLIXR Docs</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Writing your Plugin (Version 2)";
    var mkdocs_page_input_path = "writing_your_plugin.md";
    var mkdocs_page_url = "/ILLIXR/docs/writing_your_plugin/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> ILLIXR Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <p class="caption"><span class="caption-text">Latest Documentation</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="..">ILLIXR (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../getting_started/">Getting Started (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../building_illixr/">Building ILLIXR (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../debugging_illixr/">ILLIXR Debugging Tips (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../virtualization/">ILLIXR under Virtualization (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../illixr_plugins/">ILLIXR Plugins (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../modifying_a_plugin/">Modifying a Plugin (Version 2)</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Writing your Plugin (Version 2)</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#adding-a-new-plugin-common-case">Adding a New Plugin (Common Case)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#adding-a-new-plugin-general-case">Adding a New Plugin (General Case)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#tutorial">Tutorial</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../monado_illixr_runtime_overview/">Monado Overview (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../monado_integration_dataflow/">Monado Dataflow (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../logging_and_metrics/">Logging and Metrics (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../glossary/">ILLIXR Glossary (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../api/html/annotated.html">ILLIXR API (Version 2)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../LICENSE/">ILLIXR License (Version 2)</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Legacy Documentation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../legacy/v1/">ILLIXR (Version 1)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../legacy/v1/README-audio/">Audio Pipeline (Version 1)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../legacy/v1/README-efusion/">ElasticFusion (Version 1)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../legacy/v1/README-hotlab/">HOTlab (Version 1)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../legacy/v1/README-openvins/">OpenVINS (Version 1)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../legacy/v1/README-ritnet/">RITnet (Version 1)</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../legacy/v1/README-visualpp/">Visual Post-processing (Version 1)</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">ILLIXR Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Latest Documentation &raquo;</li>
        
      
    
    <li>Writing your Plugin (Version 2)</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="writing-your-plugin">Writing Your Plugin</h1>
<h2 id="adding-a-new-plugin-common-case">Adding a New Plugin (Common Case)</h2>
<p>In the common case, one need only define a <code>Makefile</code> with the line <code>include common/common.mk</code>
    and symlink common (<code>ln -s ../common common</code>).
This provides the necessary targets and uses the compiler <code>$(CXX)</code>,
    which is defined in Make based on the OS and environment variables.</p>
<ul>
<li>
<p>It compiles <code>plugin.cpp</code> and any other <code>*.cpp</code> files into the plugin.</p>
</li>
<li>
<p>It will invoke a recompile the target any time any <code>*.hpp</code> or <code>*.cpp</code> file changes.</p>
</li>
<li>
<p>It compiles with C++17. You can change this in your plugin by defining
        <code>STDCXX = ...</code> before the <code>include</code>.
    This change will not affect other plugins; just yours.</p>
</li>
<li>
<p>Libraries can be added by appending to <code>LDFLAGS</code> and <code>CFLAGS</code>, for example</p>
<p><!--- language: lang-makefile -->
    LDFLAGS := $(LDFLAGS) $(shell pkg-config --ldflags eigen3)
    CFLAGS  := $(CFLAGS) $(shell pkg-config --cflags eigen3)</p>
</li>
<li>
<p>See the source for the exact flags.</p>
</li>
<li>
<p>Inserted the path of your directory into the <code>plugin</code>-list in <code>config.yaml</code>.</p>
</li>
</ul>
<h2 id="adding-a-new-plugin-general-case">Adding a New Plugin (General Case)</h2>
<p>Each plugin can have a completely independent build system, as long as:</p>
<ul>
<li>
<p>It defines a <code>Makefile</code> with targets for <code>plugin.dbg.so</code>, <code>plugin.opt.so</code>, and <code>clean</code>.
    Inside this <code>Makefile</code>, one can defer to another build system.</p>
</li>
<li>
<p>It's compiler maintains <em>ABI compatibility</em> with the compilers used in every other plugin.
    Using the same version of Clang or GCC on the same architecture is sufficient for this.</p>
</li>
<li>
<p>It's path is inserted in the root <code>config.yaml</code>, in the plugin list.</p>
</li>
</ul>
<h2 id="tutorial">Tutorial</h2>
<p>With this, you can extend ILLIXR for your own purposes.
You can also replace any existing functionality this way.</p>
<ol>
<li>
<p>Create a new directory anywhere for your new plugin and set it up for ILLIXR.
    We recommend you also push this plugin to a git repository on Github/Gitlab if you want it
        as a part of upstream ILLIXR in the future.</p>
<ul>
<li>
<p>Create a <code>Makefile</code> with the following contents.
    See <a href="../building_illixr/">Building ILLIXR</a> for more details and alternative setups.</p>
<p><!--- language: lang-makefile -->
    include common.mk</p>
</li>
</ul>
</li>
<li>
<p>You must decide if your plugin should inherit the standardized <a href="../api/html/classILLIXR_1_1threadloop.html"><code>threadloop</code></a>
        or <a href="../api/html/classILLIXR_1_1plugin.html"><code>plugin</code></a>.</p>
<ul>
<li>
<p>If your plugin just needs to run one computation repeatedly,
        then your plugin class should extend <a href="../api/html/classILLIXR_1_1threadloop.html"><code>threadloop</code></a>.</p>
</li>
<li>
<p>If you need custom concurrency (more complicated than a loop),
        triggered concurrency (by events fired in other plugins),
        or no concurrency then your plugin class should extend <a href="../api/html/classILLIXR_1_1plugin.html"><code>plugin</code></a>.</p>
</li>
</ul>
</li>
<li>
<p>Write a file called <code>plugin.cpp</code> with this body, replacing every instance of <code>plugin_name</code>:</p>
<p><!--- language: lang-cpp -->
    #include "common/phonebook.hpp"
    #include "common/plugin.hpp"
    #include "common/threadloop.hpp"</p>
<pre><code>using namespace ILLIXR;

/// Inherit from `plugin` if you don't need the threadloop
class plugin_name : public threadloop {
public:
    plugin_name(std::string name_, phonebook* pb_)
        : threadloop{name_, pb_}
        { }
    virtual void start() override { }
    virtual ~plugin_name() override { }
};

// This line makes the plugin importable by Spindle
PLUGIN_MAIN(plugin_name);
</code></pre>
</li>
<li>
<p>At this point, you should be able to build your plugin with ILLIXR.
    Move to the ILLIXR repo and update <code>configs/native.yaml</code>.
    If the new plugin is the same type as one of the other components you will need to
        remove that component from the config before running the new component.
    For example, if the new component is a SLAM then the old SLAM needs to be removed from
        the config.
    See <a href="../building_illixr/">Building ILLIXR</a> for more details on the config file.</p>
<p><!--- language: lang-yaml -->
    plugin_groups:
      - !include "rt_slam_plugins.yaml"
      - !include "core_plugins.yaml"
      - plugin_group:
         - path: /PATH/TO/NEW/PLUGIN
         - path: ground_truth_slam/
         - path: gldemo/
         - path: debugview/</p>
<pre><code>data:
  subpath: mav0
  relative_to:
  archive_path:
  download_url: 'http://robotics.ethz.ch/~asl-datasets/ijrr_euroc_mav_dataset/vicon_room1/V1_02_medium/V1_02_medium.zip'
  demo_data: demo_data/
  loader:
    name: native
    # command: gdb -q --args %a
    profile: opt
</code></pre>
</li>
<li>
<p>Finally, run ILLIXR with your new plugin with the following command:</p>
<p><!--- language: lang-shell -->
    ./runner.sh configs/native.yaml</p>
</li>
<li>
<p>This is all that is required to be a plugin which can be loaded by Spindle in
        the ILLIXR runtime.
    Reading and writing from Phonebook and Switchboard is optional,
        but nearly every plugin does it.
    See <code>default_plugins.md</code> for more details.</p>
<p>First, we can query the <a href="../api/html/classILLIXR_1_1phonebook.html"><code>phonebook</code></a> to get various services
    including <a href="../api/html/classILLIXR_1_1switchboard.html"><code>switchboard</code></a>.
Then we query <a href="../api/html/classILLIXR_1_1switchboard.html"><code>switchboard</code></a> for event-streams (topics).
We will read <code>topic1</code>, write to <code>topic2</code>, and schedule computation on <code>topic 3</code>.
See the API documentation for <code>phonebook</code> and <code>switchboard</code> for more details.</p>
<p><!--- language: lang-cpp -->
    #include "common/phonebook.hpp"
    #include "common/plugin.hpp"
    #include "common/threadloop.hpp"</p>
<pre><code>/* When datatypes have to be common across plugins
 *     (e.g. a phonebook service or switchboard topic),
 *      they are defined in this header,
 *      which is accessible to all plugins.
 */
#include "common/data_format.hpp"

class plugin_name : public threadloop {
public:
    /* After the constructor, C++ permits a list of member-constructors.
     * We use uniform initialization (curly-braces) [1] instead of parens to
     *     avoid ambiguity [2].
     * We put the comma at the start of the line, so that lines can be copied around
     *     or deleted freely (except for the first).
     *
     * [1]: https://en.wikipedia.org/wiki/C%2B%2B11#Uniform_initialization
     * [2]: https://en.wikipedia.org/wiki/Most_vexing_parse
     */
    plugin_name(std::string name_, phonebook* pb_)
        : threadloop{name_, pb_}
          /// Find the switchboard in phonebook
        , sb{pb-&gt;lookup_impl&lt;switchboard&gt;()}
          /// Create a handle to a topic in switchboard for subscribing
        , topic1{sb-&gt;subscribe_latest&lt;topic1_type&gt;("topic1")}
          /// Create a handle to a topic in switchboard for publishing
        , topic2{sb-&gt;publish&lt;topic2_type&gt;("topic2")}
    {
        /// Read topic 1
        topic1_type* event1 = topic1.get_latest_ro();

        /// Write to topic 2
        topic2_type* event2 = new topic2_type;
        topic2.put(event2);

        /// Read topic 3 synchronously
        sb-&gt;schedule&lt;topic3_type&gt;(get_name(), "topic3", [&amp;](const topic3_type *event3) {
            /* This is a [lambda expression][1]
             *
             * [1]: https://en.cppreference.com/w/cpp/language/lambda
             */
            std::cout &lt;&lt; "Got a new event on topic3: " &lt;&lt; event3 &lt;&lt; std::endl;
        });
    }

    virtual void _p_one_iteration override() {
        std::cout &lt;&lt; "Running" &lt;&lt; std::endl;
        auto target = std::chrono::high_resolution_clock::now()
                    + std::chrono::milliseconds{10};
        reliable_sleep(target);
    }

private:
    const std::shared_ptr&lt;switchboard&gt; sb;
    std::unique_ptr&lt;reader_latest&lt;topic1_type&gt;&gt; topic1;
    std::unique_ptr&lt;writer&lt;topic2&gt;&gt; topic2;
};

/// This line makes the plugin importable by Spindle
PLUGIN_MAIN(plugin_name);
</code></pre>
</li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../monado_illixr_runtime_overview/" class="btn btn-neutral float-right" title="Monado Overview (Version 2)">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../modifying_a_plugin/" class="btn btn-neutral" title="Modifying a Plugin (Version 2)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../modifying_a_plugin/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../monado_illixr_runtime_overview/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
