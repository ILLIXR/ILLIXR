<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Writing your plugin - ILLIXR Docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Writing your plugin";
    var mkdocs_page_input_path = "writing_your_plugin.md";
    var mkdocs_page_url = "/writing_your_plugin/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> ILLIXR Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../CONTRIBUTING/">CONTRIBUTING</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../LICENSE/">LICENSE</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../building_illixr/">Building illixr</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../debugging_illixr/">Debugging illixr</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../external_switchboard_and_phonebook/">External switchboard and phonebook</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../getting_started/">Getting started</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../glossary/">Glossary</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../illixr_plugins/">Illixr plugins</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../logging_and_metrics/">Logging and metrics</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../modifying_a_plugin/">Modifying a plugin</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../monado_illixr_runtime_overview/">Monado illixr runtime overview</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../monado_integration_dataflow/">Monado integration dataflow</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../releases/">Releases</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../virtualization/">Virtualization</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Writing your plugin</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#writing-your-plugin">Writing Your Plugin</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#adding-a-new-plugin-common-case">Adding a New Plugin (Common Case)</a></li>
        
            <li><a class="toctree-l3" href="#adding-a-new-plugin-general-case">Adding a New Plugin (General Case)</a></li>
        
            <li><a class="toctree-l3" href="#tutorial">Tutorial</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Legacy</span>
    <ul class="subnav">
                <li class="">
                    
    <span class="caption-text">V1</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../legacy/v1/README-audio/">README audio</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../legacy/v1/README-efusion/">README efusion</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../legacy/v1/README-hotlab/">README hotlab</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../legacy/v1/README-openvins/">README openvins</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../legacy/v1/README-ritnet/">README ritnet</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../legacy/v1/README-visualpp/">README visualpp</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../legacy/v1/">Home</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">ILLIXR Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Writing your plugin</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="writing-your-plugin">Writing Your Plugin</h1>
<h2 id="adding-a-new-plugin-common-case">Adding a New Plugin (Common Case)</h2>
<p>In the common case, you only need to define a <code>Makefile</code> with the line <code>include common/common.mk</code>
    and symlink common (<code>ln -s ../common common</code>).
The included recipe file provides the necessary targets and uses the compiler <code>$(CXX)</code>,
    which is defined based on the OS and environment variables.
The included <code>Makefile</code>:</p>
<ul>
<li>
<p>Compiles <code>plugin.cpp</code> and any other <code>*.cpp</code> files into the plugin.</p>
</li>
<li>
<p>Will invoke a recompile of the target any time any <code>*.hpp</code> or <code>*.cpp</code> file changes.</p>
</li>
<li>
<p>Compiles with C++17.
    You can change this in your plugin by defining
        <code>STDCXX = ...</code> before the <code>include</code>.
    This change will not affect other plugins; just yours.</p>
</li>
<li>
<p>Accepts specifying libraries by appending to <code>LDFLAGS</code> and <code>CFLAGS</code>.
    For example:</p>
<!--- language: lang-makefile -->

<pre><code>LDFLAGS := $(LDFLAGS) $(shell pkg-config --ldflags eigen3)
CFLAGS  := $(CFLAGS) $(shell pkg-config --cflags eigen3)
</code></pre>
<p>See the source for the other flags and variables that you can set.</p>
</li>
</ul>
<p>Finally, place the path of your plugin directory in the <code>plugin_group</code> list
    for the configuration you would like to run (e.g. <code>ILLIXR/configs/native.yaml</code>).</p>
<h2 id="adding-a-new-plugin-general-case">Adding a New Plugin (General Case)</h2>
<p>Each plugin can have a completely independent build system, as long as:</p>
<ul>
<li>
<p>It defines a <code>Makefile</code> with targets for <code>plugin.dbg.so</code>, <code>plugin.opt.so</code>, and <code>clean</code>.
    Inside this <code>Makefile</code>, one can defer to another build system.</p>
</li>
<li>
<p>Its compiler maintains <em>ABI compatibility</em> with the compilers used in every other plugin.
    Using the same version of Clang or GCC on the same architecture is sufficient for this.</p>
</li>
<li>
<p>Its path is in the <code>plugin_group</code> list for the configuration you would like
        to run (e.g. <code>ILLIXR/configs/native.yaml</code>).</p>
</li>
</ul>
<h2 id="tutorial">Tutorial</h2>
<p>You can extend ILLIXR for your own purposes.
To add your own functionality via the plugin interface:</p>
<ol>
<li>
<p>Create a new directory anywhere for your new plugin and set it up for ILLIXR.
    We recommend you also push this plugin to a git repository on Github/Gitlab if you want it
        as a part of upstream ILLIXR in the future.</p>
<ul>
<li>
<p>Create a <code>Makefile</code> with the following contents.
    See <a href="../building_illixr/">Building ILLIXR</a> for more details and alternative setups.</p>
<!--- language: lang-makefile -->

<pre><code>include common/common.mk
</code></pre>
</li>
</ul>
</li>
<li>
<p>You must decide if your plugin should inherit the standardized <a href="../api/html/classILLIXR_1_1threadloop.html"><code>threadloop</code></a>
        or <a href="../api/html/classILLIXR_1_1plugin.html"><code>plugin</code></a>.</p>
<ul>
<li>
<p>If your plugin just needs to run one computation repeatedly, then your
        plugin class should extend <a href="../api/html/classILLIXR_1_1threadloop.html"><code>threadloop</code></a>. Your code goes in
        <code>_p_one_iteration</code>, which gets called in a hot loop. <code>threadloop</code>
        inherits from plugin, but adds threading functionality. If you don't
        use <code>_p_one_iteration</code>, inheriting from <code>threadloop</code> is superfluous;
        Inherit from plugin directly instead.</p>
</li>
<li>
<p>If you need custom concurrency (more complicated than a loop), triggered
        concurrency (by events fired in other plugins), or no concurrency
        then your plugin class should extend <a href="../api/html/classILLIXR_1_1plugin.html"><code>plugin</code></a>. Your code goes
        in the <code>start</code> method.</p>
</li>
<li>
<p>If you want to schedule data-driven work in either case, call
  <a href="../api/html/classILLIXR_1_1switchboard.html"><code>sb-&gt;schedule(...)</code></a>.</p>
</li>
<li>
<p>If you spin your own threads, they <strong>must</strong> wait for
      <code>pb-&gt;lookup_impl&lt;Stoplight&gt;()-&gt;wait_for_ready()</code> the first time they
      run. This allows the start of all threads in ILLIXR to be
      synchronized.</p>
</li>
<li>
<p>They <strong>must</strong> be joined-or-disowned at-or-before
      <code>plugin::stop()</code>. This allows ILLIXR to shutdown cleanly.</p>
</li>
</ul>
</li>
<li>
<p>Write a file called <code>plugin.cpp</code> with this body, replacing every instance of <code>plugin_name</code>:</p>
<!--- language: lang-cpp -->

<pre><code>/// A minimal/no-op ILLIXR plugin

#include "common/phonebook.hpp"
#include "common/plugin.hpp"
#include "common/threadloop.hpp"
#include &lt;chrono&gt;
#include &lt;thread&gt;

using namespace ILLIXR;

/// Inherit from plugin if you don't need the threadloop
/// Inherit from threadloop to provide a new thread to perform the task
class basic_plugin : public threadloop {
public:
    basic_plugin(std::string name_, phonebook* pb_)
        : threadloop{name_, pb_}
    {
        std::cout &lt;&lt; "Constructing basic_plugin." &lt;&lt; std::endl;
    }

    /// Note the virtual.
    virtual ~basic_plugin() override {
        std::cout &lt;&lt; "Deconstructing basic_plugin." &lt;&lt; std::endl;
    }

    /// For `threadloop` style plugins, do not override the start() method unless you know what you're doing!
    /// _p_one_iteration() is called in a thread created by threadloop::start()
    void _p_one_iteration() override {
        std::cout &lt;&lt; "This goes to the log when `log` is set in the config." &lt;&lt; std::endl;
        std::cerr &lt;&lt; "This goes to the console." &lt;&lt; std::endl;
        std::this_thread::sleep_for(std::chrono::milliseconds{100});
    }

};

/// This line makes the plugin importable by Spindle
PLUGIN_MAIN(basic_plugin);
</code></pre>
</li>
<li>
<p>At this point, you should be able to build your plugin with ILLIXR.
    Move to the ILLIXR repo and update <code>configs/native.yaml</code>.
    If the new plugin is the same type as one of the other components you will need to
        remove that component from the config before running the new component.
    For example, if the new component is a SLAM then the old SLAM needs to be removed from
        the config.
    See <a href="../building_illixr/">Building ILLIXR</a> for more details on the config file.</p>
<!--- language: lang-yaml -->

<pre><code>plugin_groups:
  - !include "rt_slam_plugins.yaml"
  - !include "core_plugins.yaml"
  - plugin_group:
     - path: /PATH/TO/NEW/PLUGIN
     - path: ground_truth_slam/
     - path: gldemo/
     - path: debugview/

data:
  subpath: mav0
  relative_to:
  archive_path:
  download_url: 'http://robotics.ethz.ch/~asl-datasets/ijrr_euroc_mav_dataset/vicon_room1/V1_02_medium/V1_02_medium.zip'
  demo_data: demo_data/
  loader:
    name: native
    # command: gdb -q --args %a
    profile: opt
</code></pre>
</li>
<li>
<p>Finally, run ILLIXR with your new plugin with the following command:</p>
<!--- language: lang-shell -->

<pre><code>./runner.sh configs/native.yaml
</code></pre>
</li>
<li>
<p>This is all that is required to be a plugin which can be loaded by Spindle in
        the ILLIXR runtime.
    Reading and writing from Phonebook and Switchboard is optional,
        but nearly every plugin does it.
    See <code>default_plugins.md</code> for more details.</p>
<p>First, we can query the <a href="../api/html/classILLIXR_1_1phonebook.html"><code>phonebook</code></a> to get various services
    including <a href="../api/html/classILLIXR_1_1switchboard.html"><code>switchboard</code></a>.
Then we query <a href="../api/html/classILLIXR_1_1switchboard.html"><code>switchboard</code></a> for event-streams (topics).
We will read <code>topic1</code>, write to <code>topic2</code>, and schedule computation on <code>topic 3</code>.
See the API documentation for <code>phonebook</code> and <code>switchboard</code> for more details.</p>
<!--- language: lang-cpp -->

<pre><code>#include "common/phonebook.hpp"
#include "common/plugin.hpp"
#include "common/threadloop.hpp"

/* When datatypes have to be common across plugins
 *     (e.g. a phonebook service or switchboard topic),
 *      they are defined in this header,
 *      which is accessible to all plugins.
 */
#include "common/data_format.hpp"

class plugin_name : public threadloop {
public:
    /* After the constructor, C++ permits a list of member-constructors.
     * We use uniform initialization (curly-braces) [1] instead of parens to
     *     avoid ambiguity [2].
     * We put the comma at the start of the line, so that lines can be copied around
     *     or deleted freely (except for the first).
     *
     * [1]: https://en.wikipedia.org/wiki/C%2B%2B11#Uniform_initialization
     * [2]: https://en.wikipedia.org/wiki/Most_vexing_parse
     */
    plugin_name(std::string name_, phonebook* pb_)
        : threadloop{name_, pb_}
          /// Find the switchboard in phonebook
        , sb{pb-&gt;lookup_impl&lt;switchboard&gt;()}
          /// Create a handle to a topic in switchboard for subscribing
        , topic1{sb-&gt;get_reader&lt;topic1_type&gt;("topic1")}
          /// Create a handle to a topic in switchboard for publishing
        , topic2{sb-&gt;get_writer&lt;topic2_type&gt;("topic2")}
    {
        /// Read topic 1
        switchboard::ptr&lt;const topic1_type&gt; event1 = topic1.get_ro();

        /// Write to topic 2
        topic2.put(
            topic2.allocate&lt;topic2_type&gt;(
                arg_1, // topic2_type::topic2_type() arg_type_1
                ...,   // ...
                arg_k  // topic2_type::topic2_type() arg_type_k
            )
        );

        /// Read topic 3 synchronously
        sb-&gt;schedule&lt;topic3_type&gt;(
            get_name(),
            "topic3",
            [&amp;](switchboard::ptr&lt;const topic3_type&gt; event3, std::size_t) {
                /* This is a [lambda expression][1]
                 *
                 * [1]: https://en.cppreference.com/w/cpp/language/lambda
                 */
                std::cout &lt;&lt; "Got a new event on topic3: " &lt;&lt; event3 &lt;&lt; std::endl;
                callback(event3);
            }
        );
    }

    virtual void _p_one_iteration override() {
        std::cout &lt;&lt; "Running" &lt;&lt; std::endl;
        auto target = std::chrono::system_clock::now()
                    + std::chrono::milliseconds{10};
        reliable_sleep(target);
    }

private:
    const std::shared_ptr&lt;switchboard&gt; sb;
    switchboard::reader&lt;topic1_type&gt; topic1;
    switchboard::writer&lt;topic2&gt; topic2;
};

/// This line makes the plugin importable by Spindle
PLUGIN_MAIN(plugin_name);
</code></pre>
</li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../legacy/v1/README-audio/" class="btn btn-neutral float-right" title="README audio">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../virtualization/" class="btn btn-neutral" title="Virtualization"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../virtualization/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../legacy/v1/README-audio/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>

</body>
</html>
