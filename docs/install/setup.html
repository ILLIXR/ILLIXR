<html>
<head>
    <title>Plugin Selector</title>
    <link href="css/prism.min.css" rel="stylesheet">
    <link href="css/code-box-copy.css" rel="stylesheet">
    <script src="js/jquery.min.js"></script>
    <script src="js/prism.min.js"></script>
    <script src="js/clipboard.min.js"></script>
    <script src="js/code-box-copy.js"></script>
    <script src="js/modules.js"></script>
    <script>
        $(document).ready(function () {
            $('.code-box-copy').codeBoxCopy();
        });
    </script>
</head>
<body>
<h1><img src="icon.png"> Installation Instructions</h1>
<h3>Pick Your OS</h3>
<table id="operating_system" style="border-spacing: 20px; border: 1px solid black;"></table>
<P>ILLIXR may compile with other versions of the above operating systems, but some of the necessary prerequesite packages are not supplied by the OS repos and will need to be compiled by hand. You should be able to use the package and cmake commands for other versions of the same OS (other than the missing packages) to compile ILLIXR. RHEL is not supported at this time as many of the prerequisite packages are not natively available.
<h3>Pick the ILLIXR plugins you want to use</h3>
<table id="listing_table" style="border-spacing: 8px; border: 1px solid black;"></table>
<P>
<div id="notes"></div>
<h3>Dependency installation:</h3>
Use the following to install the ILLIXR dependencies:
<div class="code-box-copy">
    <button class="code-box-copy__btn" data-clipboard-target="#output" title="Copy"></button>
    <pre class="language-shell"><code class="language-shell" id="output"></code></pre>
</div>
<div id="depinstall"></div>
<P>
<div id="postnotes"></div>
<h3>Build command:</h3>
Use the following to build and install ILLIXR. You can specify the install location by giving the path to CMAKE_INSTALL_PREFIX. If you want the default install path then do not add the option to the command line. Note that if your install prefix requires sudo privileges then you will need to run both the make and make install under sudo (this is due to the way cmake builds and installs some of the pre-packaged dependencies during the build phase).
<div id="cmake"></div>
<script>
    const dependencies = {};
    const plugs = {};
    const operatingSystems = {};
    const groups = [];
    var selectedOS = "";
    var selectedOSv = "";
    const plugins = new Set();

    function makeCopyable(code, name) {
        return "<div class=\"code-box-copy\">\n<button class=\"code-box-copy__btn\" data-clipboard-target=\"#" + name + "\" title=\"Copy\">\n</button>\n<pre class=\"language-shell\">\n<code class=\"language-shell\" id=\"" + name + "\">" + code + "</pre></code>\n</div>\n";
    }

    async function loadModules(){
        // read text from URL location
        //let url = 'https://astrochem.web.illinois.edu/modules.json';
        //await fetch(url)
        //    .then(response => response.json())
        //    .then(json => {
        const json = JSON.parse(ILLIXR_modules);
                for(var os of json.systems) {
                    operatingSystems[os.name] = os.versions;
                }

                for(var item of json.dependencies) {
                    var nm = "";
                    for(var i in item){
                        nm = i;
                    }
                    dependencies[nm] = {'pkg': item[nm].pkg,
                        'plugins' : []};
                }
                for(var item of json.plugins) {
                    plugins.add(item.name);
                    plugs[item.name] = item.cmake_flag;
                    for(var dep of item.dependencies) {
                        dependencies[dep].plugins.push(item.name);
                    }
                }
                for(var grp of json.groups) {
                    groups.push(grp.name);
                    groups[grp.name] = [];
                    for(var plug of grp.plugins) {
                        groups[grp.name].push(plug);
                    }
                }
            //});
    }

    function updateSudo() {
        let sudoLine = "";
        let notes = document.getElementById("notes");
        let pkgnotes = "";
        let pkginfo = "";
        let postnotes = document.getElementById("postnotes");
        let depinstall = document.getElementById("depinstall");

        notes.innerHTML = "";

        if(selectedOS == "Ubuntu") {
            sudoLine = "sudo apt-get install libglew-dev libglu1-mesa-dev libsqlite3-dev libx11-dev libgl-dev pkg-config libopencv-dev libeigen3-dev";
            postnotes.innerHTML = "";
        } else if(selectedOS == "Fedora") {
            sudoLine = "sudo dnf install glew-devel mesa-libGLU-devel sqlite-devel libX11-devel mesa-libGL-devel pkgconf-pkg-config opencv-devel eigen3-devel";
            postnotes.innerHTML = "Potential issues:<ul><li>If cmake is having trouble with some of the package-config (.pc) files used to locate packages you may need to run the following:" + makeCopyable("sudo sed -i 's/\^\[ \\t\]\*//g' /usr/lib64/pkgconfig/*", "postF") + "</li><li>If the build step is having issues finding some of the include files you may need the following:" + makeCopyable("sudo ln -s /usr/include /include", "post2F") + "</li></ul>";
        } else {
            sudoLine = "sudo yum install glew-devel mesa-libGLU-devel sqlite-devel libX11-devel mesa-libGL-devel pkgconf-pkg-config vtk-devel eigen3-devel";
            pkginfo = "Notes:<br>Centos does not provide a complete version of OpenCV in their repos, in particular the 'viz' component is missing. You will need to install the VTK-devel package and the ILLIXR build system will compile OpenCV from source.<P>You may also need to run the following:" + makeCopyable("sudo dnf -y install dnf-plugins-core epel-release\nsudo dnf config-manager --set-enabled crb", "pkgC");
            postnotes.innerHTML = "Potential issues:<ul><li>If cmake is having trouble with some of the package-config (.pc) files used to locate packages you may need to run the following:" + makeCopyable("sudo sed -i 's/\^\[ \\t\]\*//g' /usr/lib64/pkgconfig/*", "postC") + "</li><li>If the build step is having issues finding some of the include files you may need the following:" + makeCopyable("sudo ln -s /usr/include /include", "post2C") + "</li></ul>";
        }

        for(var m in dependencies) {
            var checked = false;
            for(var p of dependencies[m].plugins) {
                checked ||= document.getElementById(p).checked;
            }
            if(checked) {
                sudoLine += " " + dependencies[m].pkg[selectedOS][selectedOSv].pkg;
                if(dependencies[m].pkg[selectedOS][selectedOSv].postnotes !== "") {
                    pkgnotes += "<P>" + dependencies[m].pkg[selectedOS][selectedOSv].postnotes;
                }
                if(dependencies[m].pkg[selectedOS][selectedOSv].notes !== "") {
                    if(pkginfo !== "") {
                        pkginfo += "<P>";
                    }
                    pkginfo +=  dependencies[m].pkg[selectedOS][selectedOSv].notes;
                }
            }
        }
        if(pkginfo !== "") {
            notes.innerHTML = "<h3>Notes:</h3>" + pkginfo;
        }
        depinstall.innerHTML = pkgnotes;

        document.getElementById("output").innerHTML = sudoLine;

        cmakeLine = "git clone https://github.com/ILLIXR/ILLIXR\ncd ILLIXR\nmkdir build\ncd build\ncmake .. -DCMAKE_INSTALL_PREFIX=<LOCATION>";
        var group_check = false;
        if(document.getElementById("ALL_plugins").checked) {
            cmakeLine += " -DBUILD_GROUP=ALL";
            group_check = true;
        } else {
            for(var g of groups) {
                if(document.getElementById("group_" + g).checked) {
                    cmakeLine += " -DBUILD_GROUP=" + g.toUpperCase();
                    group_check = true;
                    break;
                }
            }
        }
        if(!group_check) {
            for(var p of plugins) {
                if(document.getElementById(p).checked) {
                    cmakeLine += " -D" + plugs[p];
                }
            }
        }
        cmakeLine += "\nmake\nmake install";
        document.getElementById("cmake").innerHTML = makeCopyable(cmakeLine, "cmakeC");

    }

    function updateOS(os_str) {
        const items = os_str.split(".");
        selectedOS = items[0];
        selectedOSv = items[1];
        updateSudo();
    }
    function checkAll() {
        for(var p of plugins) {
            document.getElementById(p).checked = document.getElementById("ALL_plugins").checked;
        }
        updateSudo();
    }
    function checkGroup(group_name) {
        for(var p of plugins) {
            var setChecked = false;
            for(var pl of groups[group_name]) {
                if(p == pl) {
                    setChecked = true;
                    break;
                }
            }
            document.getElementById(p).checked = setChecked;
        }
        updateSudo();
    }

    function updateChecked() {
        document.getElementById("None_plugins").checked = true;
        updateSudo();
    }
    async function setUpPage() {
        await loadModules();
        let osref = document.getElementById("operating_system");
        let osrow = osref.insertRow(-1);
        for(var x in operatingSystems) {
            var txt = x + ":";
            for(var ver of operatingSystems[x]) {
                txt += "<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='radio' id='" + x + "." + ver + "' name='os_choice' value='" + x + "." + ver + "' onclick='updateOS(this.value);'>" + ver;
            }
            let cell = osrow.insertCell(-1);
            cell.style.verticalAlign = "top";
            cell.innerHTML = txt;
        }
        selectedOS = "Ubuntu";
        selectedOSv = "22";
        document.getElementById(selectedOS + "." + selectedOSv).checked = true;
        let tabRef = document.getElementById("listing_table");
        let count = 0;
        let currentRow = tabRef.insertRow(-1);

        let groupcell = currentRow.insertCell(-1);
        groupcell.appendChild(document.createTextNode("Groups:"));
        let all_cell = currentRow.insertCell(-1);
        let all_check = document.createElement("INPUT");
        all_check.setAttribute("type", "radio");
        all_check.setAttribute("onclick", "checkAll();");
        all_check.setAttribute("id", "ALL_plugins");
        all_check.setAttribute("value", "ALL_plugins");
        all_check.setAttribute("name", "group_selection");
        let all_label = document.createElement("LABEL");
        all_label.setAttribute("for", "ALL_plugins");
        all_label.appendChild(document.createTextNode("All"));
        all_cell.appendChild(all_check);
        all_cell.appendChild(all_label);

        for(var g of groups) {
            let cell = currentRow.insertCell(-1);
            let radio = document.createElement("INPUT");
            radio.setAttribute("type", "radio");
            radio.setAttribute("onclick", "checkGroup('" +  g + "');");
            radio.setAttribute("id", "group_" + g);
            radio.setAttribute("value", "group_" + g);
            radio.setAttribute("name", "group_selection");
            let label = document.createElement("LABEL");
            label.setAttribute("for", "group_" + g);
            label.appendChild(document.createTextNode(g));
            cell.appendChild(radio);
            cell.appendChild(label);
        }
        let none_cell = currentRow.insertCell(-1);
        let none_check = document.createElement("INPUT");
        none_check.setAttribute("type", "radio");
        none_check.setAttribute("onclick", "updateSudo();");
        none_check.setAttribute("id", "None_plugins");
        none_check.setAttribute("value", "None_plugins");
        none_check.setAttribute("name", "group_selection");
        none_check.checked = true;
        let none_label = document.createElement("LABEL");
        none_label.setAttribute("for", "None_plugins");
        none_label.appendChild(document.createTextNode("None"));
        none_cell.appendChild(none_check);
        none_cell.appendChild(none_label);

        currentRow = tabRef.insertRow(-1);
        for(const dep of plugins) {
            if(count >= 5) {
                currentRow = tabRef.insertRow(-1);
                count = 0;
            }
            let cell = currentRow.insertCell(-1);
            let x = document.createElement("INPUT");
            x.setAttribute("type", "checkbox");
            x.setAttribute("onclick", "updateChecked();");
            x.setAttribute("id", dep);
            let y = document.createElement("LABEL");
            y.setAttribute("for", dep);
            y.appendChild(document.createTextNode(dep));
            cell.appendChild(x);
            cell.appendChild(y);
            count += 1;
        }
        updateSudo();
    }
    window.onload = setUpPage();
</script>
</body>
</html>