
string(TOUPPER ${MAKE_DOCKERFILE} MAKE_DOCKERFILE)
if(MAKE_DOCKERFILE MATCHES "^YES|ON|ALL")
    set(MAKE_DOCKERFILE "ALL")
else()
    string(REPLACE "," ";" MAKE_DOCKERFILE ${MAKE_DOCKERFILE})
endif()
set(MAKE_DOCKERFILE ${MAKE_DOCKERFILE} CACHE STRING "")


#file(STRINGS "modules-comp.dckr" MODULE_YAML)
set(COUNTER 0)
set(OPERATING_SYSTEMS "")
set(IN_SYSTEMS FALSE)
set(IN_OS FALSE)
set(IN_VERSIONS FALSE)
set(CURRENT_OS "")

file(READ ../docs/docs/modules.json MODULE_TEMP)
string(REPLACE "@PROFILES@" "" MODULE_JSON "${MODULE_TEMP}")
file(WRITE modules-comp.json "${MODULE_JSON}")
if(CMAKE_MAJOR_VERSION GREATER_EQUAL 3 AND CMAKE_MINOR_VERSION GREATER_EQUAL 19)
    string(JSON POSSIBLE_SYSTEMS GET ${MODULE_JSON} systems)
    string(JSON NUM_OS LENGTH ${POSSIBLE_SYSTEMS})
    math(EXPR NUM_OS "${NUM_OS} - 1")
    foreach(IDX RANGE ${NUM_OS})
        string(JSON CURRENT_OS GET ${POSSIBLE_SYSTEMS} ${IDX} name)
        list(APPEND OPERATING_SYSTEMS ${CURRENT_OS})
        set(${CURRENT_OS}_VERSIONS "")
        string(JSON VERSIONS GET ${POSSIBLE_SYSTEMS} ${IDX} versions)
        string(JSON NUM_VER LENGTH ${VERSIONS})
        math(EXPR NUM_VER "${NUM_VER} - 1")
        foreach(VIDX RANGE ${NUM_VER})
            string(JSON CVERS GET ${VERSIONS} ${VIDX})
            list(APPEND ${CURRENT_OS}_VERSIONS ${CVERS})
        endforeach()
    endforeach()
else()
    string(REPLACE "[" "|" MODULE_JSON ${MODULE_JSON})
    string(REPLACE "]" "?" MODULE_JSON ${MODULE_JSON})
    string(REPLACE "\n" ";" MODULE_JSON ${MODULE_JSON})

    foreach(LINE IN LISTS MODULE_JSON)
        if(NOT IN_SYSTEMS)
            string(FIND ${LINE} "systems" FOUND)
            if(${FOUND} GREATER -1)
                set(IN_SYSTEMS TRUE)
                math(EXPR COUNTER "${COUNTER} + 1")
            endif()
        else()
            string(FIND ${LINE} "|" FOUND)
            if(FOUND GREATER -1)
                math(EXPR COUNTER "${COUNTER} + 1")
            endif()
            string(FIND ${LINE} "?" FOUND)
            if(FOUND GREATER -1)
                math(EXPR COUNTER "${COUNTER} - 1")
                if(IN_VERSIONS)
                    set(IN_VERSIONS FALSE)
                endif()
            endif()
            if(${COUNTER} EQUAL 0)
                break()
            endif()
            if(NOT IN_OS)
                string(FIND ${LINE} "name" FOUND)
                if(${FOUND} GREATER -1)
                    string(REPLACE "\"name\": " "" LINE ${LINE})
                    string(REPLACE "\"" "" LINE ${LINE})
                    string(REPLACE "," "" LINE ${LINE})
                    string(STRIP ${LINE} LINE)
                    set(CURRENT_OS ${LINE})
                    list(APPEND OPERATING_SYSTEMS "${CURRENT_OS}")
                    set(${CURRENT_OS}_VERSIONS "")
                    set(IN_OS TRUE)
                    continue()
                endif()
            else()
                string(FIND ${LINE} "}" FOUND)
                if(${FOUND} GREATER -1)
                    set(IN_OS FALSE)
                    continue()
                endif()
                if(NOT IN_VERSIONS)
                    string(FIND ${LINE} "versions" FOUND)
                    if(${FOUND} GREATER -1)
                        set(IN_VERSIONS TRUE)
                        continue()
                    endif()
                else()
                    string(REGEX MATCH "([0-9]+)" VERSION ${LINE})
                    if(VERSION)
                        list(APPEND ${CURRENT_OS}_VERSIONS ${VERSION})
                        #list(APPEND OPERATING_SYSTEMS "${CURRENT_OS}${VERSION}")
                    endif()
                endif()
            endif()
        endif()
    endforeach()
endif()

string(REPLACE ";" "," DOCKER_STRING ${MAKE_DOCKERFILE})
# add target to generate dockerfiles
add_custom_target(dockerfile ALL
                  COMMAND ${CMAKE_SOURCE_DIR}/docker/generate_dockerfiles.py -f modules-comp.json --os=${DOCKER_STRING})

if(BUILD_DOCKER)
    add_custom_target(docker ALL
                      COMMAND ${CMAKE_SOURCE_DIR}/docker/build_docker.py --os=${DOCKER_STRING}
                      DEPENDS dockerfile)

    if(MAKE_DOCKERFILE STREQUAL "ALL")
        foreach(OSV IN LISTS OPERATING_SYSTEMS)
            set(CUR_VERS "")
            add_custom_target(docker_${OSV}
                              COMMAND ${CMAKE_SOURCE_DIR}/docker/generate_dockerfiles.py --os=${OSV}
                              DEPENDS dockerfile)
            foreach(VERSION IN LISTS ${OSV}_VERSIONS)
                add_custom_target(docker_${OSV}-${VERSION}
                                  COMMAND ${CMAKE_SOURCE_DIR}/docker/generate_dockerfiles.py --os=${OSV}-${VERSION}
                                  DEPENDS dockerfile)
            endforeach ()
        endforeach ()
    else()
        foreach(ITEM IN LISTS MAKE_DOCKERFILE)
            string(FIND ${ITEM} "-" FOUND)
            set(MTCH FALSE)
            if(FOUND GREATER -1)
                string(REPLACE "-" ";" VER_STR ${ITEM})
                list(GET VER_STR 0 VERSION)
                string(TOUPPER ${VERSION} VERSION)
                list(GET VER_STR 1 VER_NUM)
                foreach(OPS IN LIST OPERATING_SYSTEMS)
                    string(TOUPPER ${OPS} UPPER_OPS)
                    if(VERSION STREQUAL UPPER_OPS)
                        list(FIND ${OPS}_VERSIONS ${VERNUM} FOUND)
                        if(FOUND GREATER -1)
                            set(MTCH TRUE)

                            add_custom_target(docker_${OPS}-${VERNUM}
                                              COMMAND ${CMAKE_SOURCE_DIR}/docker/generate_dockerfiles.py --os=${OPS}-${VERNUM}
                                              DEPENDS dockerfile)
                            break()
                        endif()
                    endif()
                endforeach()
            else()
                string(TOUPPER ${ITEM} UPPER_OS)
                foreach(OPS IN LIST OPERATING_SYSTEMS)
                    string(TOUPPER ${OPS} UPPER_OPS)
                    if(UPPER_OS STREQUAL UPPER_OPS)
                        set(MTCH TRUE)
                        foreach(VER IN LISTS ${OPS}_VERSIONS)
                            add_custom_target(docker_${OPS}-${VER}
                                              COMMAND ${CMAKE_SOURCE_DIR}/docker/generate_dockerfiles.py --os=${OPS}-${VER}
                                              DEPENDS dockerfile)
                        endforeach ()
                        break()
                    endif()
                endforeach()

            endif()
            if(NOT MTCH)
                message(FATAL_ERROR "Could not find ${ITEM}")
            endif()
        endforeach()
    endif()

        #        list(APPEND CUR_VERS "${OSV}-${VERSION}")
    #        add_custom_target(dockerfile_${OSV}-${VERSION}
    #                          COMMAND ${CMAKE_SOURCE_DIR}/docker/generate_dockerfiles.py --file=modules-comp.json --os=${OSV}-${VERSION})
    #        add_custom_target(docker_${OSV}-${VERSION}
    #                          COMMAND ${CMAKE_SOURCE_DIR}/docker/generate_dockerfiles.py --file=modules-comp.json --os=${OSV}-${VERSION} --build)
    #    endforeach()
    #    string(REPLACE ";" "," CUR_VERS "${CUR_VERS}")
    #    add_custom_target(dockerfile_${OSV}
    #                      COMMAND ${CMAKE_SOURCE_DIR}/docker/generate_dockerfiles.py --file=modules-comp.json --os=${OSV})
    #    add_custom_target(docker_${OSV}
    #                      COMMAND ${CMAKE_SOURCE_DIR}/docker/generate_dockerfiles.py --file=modules-comp.json --os=${OSV} --build)
    #endforeach()
endif()
